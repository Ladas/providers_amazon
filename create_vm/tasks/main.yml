---
- debug:
    msg: "Created security group {{ created_security_group | to_nice_yaml }}"
- debug:
    msg: "Security group id {{ security_group_id }}"
- name: "'security_group_id' is empty, trying 'created_security_group.group_id'"
  set_facts:
    security_group_id: {{ created_security_group.group_id }}
  when: security_group_id is not defined or security_group_id == ''
- debug:
    msg: "Security group id {{ security_group_id }}"
- name: Provision EC2 Instance
  local_action:
    module: ec2
    group: "{{ security_group_id }}"
    instance_type: "{{ instance_type}}"
    image: "{{ image_uuid }}"
    wait: true
    region: "{{ region }}"
    key_name: "{{ key_pair }}"
    count: "{{ count }}"
    vpc_subnet_id: "{{ vpc_subnet_id }}"
    assign_public_ip: "{{ assign_public_ip }}"
    instance_tags: "{{ instance_tags | from_yaml }}"
  register: created_instances
- set_stats:
    data:
      created_instances: "{{ created_instances }}"
